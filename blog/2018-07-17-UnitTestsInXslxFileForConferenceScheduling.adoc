= Unit tests in .xlsx files
:page-interpolate: true
:awestruct-author: MusaTalluzi
:awestruct-layout: blogPostBase
:awestruct-tags: [useCase]

After you implement a planning problem, you must write unit tests for every score rule.


== Traditional unit tests

In Conference Scheduling example, if you want to test room conflict constraint (hard penalty per pair of talks in the same room in overlapping timeslots)
you might write something like this:
[source,java]
----
@Test
public void roomConflict() {
    TalkType talkType = new TalkType(0L, "type1");
    Talk talk1 = new Talk(1L)
            .withTalkType(talkType)
            .withSpeakerList(Collections.emptyList())
            .withRequiredRoomTagSet(Collections.emptySet())
            .withPreferredRoomTagSet(Collections.emptySet())
            .withProhibitedRoomTagSet(Collections.emptySet())
            .withUndesiredRoomTagSet(Collections.emptySet())
            .withRequiredTimeslotTagSet(Collections.emptySet())
            .withPreferredTimeslotTagSet(Collections.emptySet())
            .withProhibitedTimeslotTagSet(Collections.emptySet())
            .withUndesiredTimeslotTagSet(Collections.emptySet());
    Talk talk2 = new Talk(2L)
            .withTalkType(talkType)
            .withSpeakerList(Collections.emptyList())
            .withRequiredRoomTagSet(Collections.emptySet())
            .withPreferredRoomTagSet(Collections.emptySet())
            .withProhibitedRoomTagSet(Collections.emptySet())
            .withUndesiredRoomTagSet(Collections.emptySet())
            .withRequiredTimeslotTagSet(Collections.emptySet())
            .withPreferredTimeslotTagSet(Collections.emptySet())
            .withProhibitedTimeslotTagSet(Collections.emptySet())
            .withUndesiredTimeslotTagSet(Collections.emptySet());
    LocalDateTime start1 = LocalDateTime.of(2018, 1, 1, 9, 0);
    LocalDateTime end1 = LocalDateTime.of(2018, 1, 1, 10, 0);
    LocalDateTime start2 = LocalDateTime.of(2018, 1, 1, 9, 30);
    LocalDateTime end2 = LocalDateTime.of(2018, 1, 1, 10, 30);
    LocalDateTime start3 = LocalDateTime.of(2018, 1, 1, 10, 0);
    LocalDateTime end3 = LocalDateTime.of(2018, 1, 1, 11, 0);
    Timeslot slot1 = new Timeslot(1L)
            .withTalkTypeSet(Collections.singleton(talkType))
            .withStartDateTime(start1)
            .withEndDateTime(end1);
    Timeslot slot2 = new Timeslot(2L)
            .withTalkTypeSet(Collections.singleton(talkType))
            .withStartDateTime(start2)
            .withEndDateTime(end2);
    Timeslot slot3 = new Timeslot(3L)
            .withTalkTypeSet(Collections.singleton(talkType))
            .withStartDateTime(start3)
            .withEndDateTime(end3);
    Room room1 = new Room(1L)
            .withTalkTypeSet(Collections.singleton(talkType))
            .withUnavailableTimeslotSet(Collections.emptySet());
    ConferenceSolution solution = new ConferenceSolution(1L)
            .withTalkTypeList(Collections.singletonList(talkType))
            .withTalkList(Arrays.asList(talk1, talk2))
            .withTimeslotList(Arrays.asList(slot1, slot2, slot3))
            .withRoomList(Collections.singletonList(room1))
            .withSpeakerList(Collections.emptyList());
    scoreVerifier.assertHardWeight(ROOM_CONFLICT, 0, solution);
    // talks in same room without overlapping time slots
    talk1.withRoom(room1).withTimeslot(slot1);
    talk2.withRoom(room1).withTimeslot(slot3);
    scoreVerifier.assertHardWeight(ROOM_CONFLICT, 0, solution);
    // talks in same room with overlapping time slots
    talk2.withTimeslot(slot2);
    scoreVerifier.assertHardWeight(ROOM_CONFLICT, -10, solution);
    }
----

In order to test room conflict, you need to initialize two talks, three timeslots and one room.
However, the previous snippet of code is too much for such a simple unit test, most of the boilerplate code is for
initializing required fields for the conference solution that you do not need for the unit test, and you must do that for every single unit test.
For more complex constraints, it gets too cumbersome to write traditional unit tests and reason about them.


== Unit tests in .xlsx files
In order to avoid initializing unwanted fields, you can take advantage of https://github.com/kiegroup/optaplanner/blob/master/optaplanner-examples/src/main/java/org/optaplanner/examples/conferencescheduling/persistence/ConferenceSchedulingXlsxFileIO.java[ConferenceSchedulingXlsxFileIO]
to initialize them for you, and only write what you want to use. Also you can use them for all other unit tests.

To test room conflict using xlsx file, what you want is three timeslots, two talks and one room:

image::timeslots.png[link="timeslots.png" role="thumbnail"]
image::talks.png[link="talks.png" role="thumbnail"]
image::rooms.png[link="rooms.png" role="thumbnail"]

After you initialize the required fields, you need to create a separate sheet for every score verification.

image::roomConflict1.png[link="roomConflict1.png" role="thumbnail" alt="roomConflict1"]
image::roomConflict2.png[link="roomConflict2.png" role="thumbnail"]

In every test sheet (blue color), specify the constraint package, constraint name and expected score. Then assign the talks to
rooms and timeslots and visualize them easily. Note that you do not need to list all the timeslots and rooms
declared in Timeslots and Rooms sheets.


== Conclusion
To test your score rules in an xlsx file, follow these steps:

1. List all the required fields for your tests in the setup sheets.
2. For every score verification, create a separate blue test sheet with the constraint package, constraint name and expcted score.
3. List only the fields that you want to use for the corresponding rule.
4. Set _testFileName_ in https://github.com/kiegroup/optaplanner/blob/master/optaplanner-examples/src/main/test/java/org/optaplanner/examples/conferencescheduling/solver/ConferenceSchedulingScoreRulesXlsxTest.java[ConferenceSchedulingScoreRulesXlsxTest] and run the test file.

The test file clones a separate solution instance for every test sheet, so the assigned planning variables in one sheet will not affect
the score in subsequent sheets.


== Related material
https://www.optaplanner.org/blog/2018/02/19/SchedulingVoxxedDaysZurich2018.html[Scheduling Voxxed Days Zurich 2018 with OptaPlanner]

+++
<iframe width="853" height="480" src="https://www.youtube.com/embed/R0JizNdxEjU" frameborder="0" allowfullscreen></iframe>
+++
